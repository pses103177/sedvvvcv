<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>å‹‡è€…è¿·å®® RPG</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- React & ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    
    <!-- Babel for JSX -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <style>
        body {
            overscroll-behavior: none;
            user-select: none;
            -webkit-user-select: none;
        }
        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-5px); }
            75% { transform: translateX(5px); }
        }
        .animate-shake {
            animation: shake 0.2s ease-in-out;
        }
        /* Hide scrollbar for clean UI */
        ::-webkit-scrollbar {
            width: 6px;
            height: 6px;
        }
        ::-webkit-scrollbar-track {
            background: #1c1917; 
        }
        ::-webkit-scrollbar-thumb {
            background: #44403c; 
            border-radius: 3px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #57534e; 
        }
    </style>
</head>
<body class="bg-stone-900 text-white h-screen overflow-hidden">
    <div id="root" class="h-full w-full"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;

        // --- Constants & Config ---
        const MAP_SIZE = 10;
        const VISIBILITY_RADIUS = 2;

        const CLASSES = {
            WARRIOR: { id: 'warrior', name: 'é‡è£æˆ°å£«', icon: 'ğŸ›¡ï¸', hp: 80, atk: 8, desc: 'å …éŸŒä¸æ‹”ï¼Œæ“æœ‰æœ€é«˜çš„åˆå§‹ç”Ÿå‘½å€¼ã€‚' },
            MAGE: { id: 'mage', name: 'å…ƒç´ æ³•å¸«', icon: 'ğŸ”®', hp: 40, atk: 15, desc: 'ç²¾é€šå¥§è¡“ï¼Œæ”»æ“ŠåŠ›æ¥µé«˜ä½†èº«é«”è„†å¼±ã€‚' },
            ROGUE: { id: 'rogue', name: 'æš—å½±åˆºå®¢', icon: 'ğŸ—¡ï¸', hp: 55, atk: 12, desc: 'èº«æ‰‹æ•æ·ï¼Œæ“æœ‰å¹³è¡¡çš„æ”»æ“Šèˆ‡ç”Ÿå­˜èƒ½åŠ›ã€‚' }
        };

        const ENTITIES = {
            WALL: { id: 'wall', icon: '', color: 'bg-stone-700' },
            FLOOR: { id: 'floor', icon: '', color: 'bg-stone-800' },
            ENEMY_S: { id: 'slime', icon: 'ğŸ’§', hp: 20, atk: 4, exp: 10, gold: 5, name: 'å²èŠå§†' },
            ENEMY_M: { id: 'goblin', icon: 'ğŸ‘¹', hp: 45, atk: 8, exp: 25, gold: 15, name: 'å“¥å¸ƒæ—' },
            ENEMY_L: { id: 'orc', icon: 'ğŸ‘º', hp: 80, atk: 12, exp: 50, gold: 30, name: 'åŠç¸äºº' },
            BOSS: { id: 'dragon', icon: 'ğŸ‰', hp: 200, atk: 20, exp: 500, gold: 100, name: 'æ·±æ·µé­”é¾' },
            CHEST: { id: 'chest', icon: 'ğŸ', color: 'text-yellow-400' },
            SHOP: { id: 'shop', icon: 'â›º', color: 'text-green-400' },
            STAIRS: { id: 'stairs', icon: 'ğŸšª', color: 'text-gray-400' }
        };

        // --- Helper Functions ---
        const generateMap = () => {
            let map = Array(MAP_SIZE).fill().map(() => Array(MAP_SIZE).fill(ENTITIES.FLOOR));
            
            // Add Walls (Random noise)
            for (let y = 0; y < MAP_SIZE; y++) {
                for (let x = 0; x < MAP_SIZE; x++) {
                    if (Math.random() < 0.2) map[y][x] = ENTITIES.WALL;
                }
            }

            // Ensure start is clear
            map[0][0] = ENTITIES.FLOOR;
            map[0][1] = ENTITIES.FLOOR;
            map[1][0] = ENTITIES.FLOOR;

            // Place Entities
            const placeEntity = (entity, count = 1) => {
                let placed = 0;
                while (placed < count) {
                    let x = Math.floor(Math.random() * MAP_SIZE);
                    let y = Math.floor(Math.random() * MAP_SIZE);
                    // Don't spawn on start (0,0) or walls or existing entities
                    if ((x !== 0 || y !== 0) && map[y][x] === ENTITIES.FLOOR) {
                        map[y][x] = entity;
                        placed++;
                    }
                }
            };

            placeEntity(ENTITIES.ENEMY_S, 4);
            placeEntity(ENTITIES.ENEMY_M, 3);
            placeEntity(ENTITIES.ENEMY_L, 2);
            placeEntity(ENTITIES.CHEST, 3);
            placeEntity(ENTITIES.SHOP, 1);
            placeEntity(ENTITIES.BOSS, 1);

            return map;
        };

        // --- Main Component ---
        function RPGGame() {
            // Game State
            const [screen, setScreen] = useState('start'); // start, charSelect, map, battle, shop, win, gameover
            const [map, setMap] = useState([]);
            const [playerPos, setPlayerPos] = useState({ x: 0, y: 0 });
            const [revealedTiles, setRevealedTiles] = useState([]);
            const [logs, setLogs] = useState(['æ­¡è¿ä¾†åˆ°å‹‡è€…è¿·å®®ï¼è«‹é¸æ“‡ä½ çš„è·æ¥­ã€‚']);
            
            // Player Stats
            const [player, setPlayer] = useState({
                name: 'å†’éšªè€…',
                icon: 'ğŸ‘¤',
                maxHp: 50,
                hp: 50,
                atk: 10,
                lvl: 1,
                exp: 0,
                expToNext: 50,
                gold: 0,
                potions: 1
            });

            // Battle State
            const [currentEnemy, setCurrentEnemy] = useState(null);
            const [battleLog, setBattleLog] = useState([]);
            const [isPlayerTurn, setIsPlayerTurn] = useState(true);

            // Audio/Visual Feedback
            const [shake, setShake] = useState(false);

            // --- Initialization ---
            useEffect(() => {
                if (screen === 'start') {
                    const newMap = generateMap();
                    setMap(newMap);
                    setPlayerPos({ x: 0, y: 0 });
                    updateVisibility(0, 0);
                }
            }, [screen]);

            // --- Logic: Class Selection ---
            const selectClass = (classKey) => {
                const cls = CLASSES[classKey];
                setPlayer(prev => ({
                    ...prev,
                    name: cls.name,
                    icon: cls.icon,
                    maxHp: cls.hp,
                    hp: cls.hp,
                    atk: cls.atk,
                    gold: 10, // Starting gold bonus
                    potions: 1
                }));
                setScreen('map');
                addLog(`ä½ é¸æ“‡äº† ${cls.name}ï¼å†’éšªé–‹å§‹ã€‚`);
            };

            // --- Logic: Movement & Interaction ---
            const updateVisibility = (px, py) => {
                const newRevealed = [...revealedTiles];
                for (let y = py - VISIBILITY_RADIUS; y <= py + VISIBILITY_RADIUS; y++) {
                    for (let x = px - VISIBILITY_RADIUS; x <= px + VISIBILITY_RADIUS; x++) {
                        if (x >= 0 && x < MAP_SIZE && y >= 0 && y < MAP_SIZE) {
                            if (!newRevealed.some(t => t.x === x && t.y === y)) {
                                newRevealed.push({ x, y });
                            }
                        }
                    }
                }
                setRevealedTiles(newRevealed);
            };

            const movePlayer = (dx, dy) => {
                if (screen !== 'map') return;

                const newX = playerPos.x + dx;
                const newY = playerPos.y + dy;

                if (newX < 0 || newX >= MAP_SIZE || newY < 0 || newY >= MAP_SIZE) return;

                const targetTile = map[newY][newX];

                if (targetTile === ENTITIES.WALL) {
                    addLog("é‚£æ˜¯ä¸€é¢ç‰†ï¼Œç„¡æ³•ç©¿éã€‚");
                    return;
                }

                setPlayerPos({ x: newX, y: newY });
                updateVisibility(newX, newY);

                // Interaction Logic
                if (targetTile.id === 'chest') {
                    const goldFound = Math.floor(Math.random() * 20) + 10;
                    setPlayer(p => ({ ...p, gold: p.gold + goldFound }));
                    addLog(`æ‰“é–‹å¯¶ç®±ï¼ç²å¾— ${goldFound} é‡‘å¹£ã€‚`);
                    // Remove chest
                    const newMap = [...map];
                    newMap[newY][newX] = ENTITIES.FLOOR;
                    setMap(newMap);
                } else if (targetTile.id === 'shop') {
                    setScreen('shop');
                    addLog("é€²å…¥äº†ç¥ç§˜å•†äººçš„å¸³ç¯·ã€‚");
                } else if (['slime', 'goblin', 'orc', 'dragon'].includes(targetTile.id)) {
                    startBattle(targetTile);
                }
            };

            // --- Logic: Battle ---
            const startBattle = (enemyTemplate) => {
                setCurrentEnemy({ ...enemyTemplate, maxHp: enemyTemplate.hp });
                setScreen('battle');
                setBattleLog([`é­é‡äº† ${enemyTemplate.name}ï¼`]);
                setIsPlayerTurn(true);
            };

            const battleAction = (action) => {
                if (!currentEnemy || !isPlayerTurn) return;

                let dmg = 0;
                let logMsg = "";
                
                // Player Turn
                if (action === 'attack') {
                    dmg = Math.floor(player.atk * (1 + Math.random() * 0.4));
                    const crit = Math.random() < 0.2;
                    if (crit) dmg = Math.floor(dmg * 1.5);
                    
                    setCurrentEnemy(e => ({ ...e, hp: e.hp - dmg }));
                    logMsg = `ä½ æ”»æ“Šäº† ${currentEnemy.name}ï¼Œé€ æˆ ${dmg} é»${crit ? 'æš´æ“Š' : ''}å‚·å®³ï¼`;
                    triggerShake();
                } else if (action === 'heal') {
                    if (player.potions > 0) {
                        const healAmt = 30;
                        setPlayer(p => ({ ...p, hp: Math.min(p.maxHp, p.hp + healAmt), potions: p.potions - 1 }));
                        logMsg = `ä½¿ç”¨äº†è—¥æ°´ï¼Œæ¢å¾© ${healAmt} é»ç”Ÿå‘½ã€‚`;
                    } else {
                        logMsg = "æ²’æœ‰è—¥æ°´äº†ï¼";
                    }
                } else if (action === 'run') {
                    if (currentEnemy.id === 'dragon') {
                        logMsg = "ç„¡æ³•å¾ Boss æˆ°ä¸­é€ƒè·‘ï¼";
                        setBattleLog(prev => [logMsg, ...prev]);
                        return;
                    }
                    if (Math.random() > 0.5) {
                        addLog("æˆåŠŸé€ƒé›¢äº†æˆ°é¬¥ã€‚");
                        setScreen('map');
                        return;
                    } else {
                        logMsg = "é€ƒè·‘å¤±æ•—ï¼";
                    }
                }

                setBattleLog(prev => [logMsg, ...prev]);
                
                // Check Enemy Death
                if (currentEnemy.hp - (action === 'attack' ? dmg : 0) <= 0) {
                    setTimeout(() => winBattle(), 1000);
                } else {
                    setIsPlayerTurn(false);
                    setTimeout(enemyTurn, 1000);
                }
            };

            const enemyTurn = () => {
                if (!currentEnemy) return;
                
                // Simple AI
                const dmg = Math.floor(currentEnemy.atk * (0.8 + Math.random() * 0.4));
                setPlayer(p => ({ ...p, hp: p.hp - dmg }));
                setBattleLog(prev => [`${currentEnemy.name} æ”»æ“Šäº†ä½ ï¼Œé€ æˆ ${dmg} é»å‚·å®³ã€‚`, ...prev]);
                triggerShake();

                // Check Player Death
                if (player.hp - dmg <= 0) {
                    setTimeout(() => setScreen('gameover'), 1000);
                } else {
                    setIsPlayerTurn(true);
                }
            };

            const winBattle = () => {
                const goldEarned = currentEnemy.gold;
                const expEarned = currentEnemy.exp;
                
                addLog(`æˆ°å‹ ${currentEnemy.name}ï¼ç²å¾— ${expEarned} EXP, ${goldEarned} é‡‘å¹£ã€‚`);
                
                let newPlayer = { ...player, gold: player.gold + goldEarned, exp: player.exp + expEarned };
                
                // Level Up Logic
                if (newPlayer.exp >= newPlayer.expToNext) {
                    newPlayer.lvl += 1;
                    newPlayer.exp -= newPlayer.expToNext;
                    newPlayer.expToNext = Math.floor(newPlayer.expToNext * 1.5);
                    newPlayer.maxHp += 20;
                    newPlayer.hp = newPlayer.maxHp;
                    newPlayer.atk += 5;
                    addLog("å‡ç´šäº†ï¼å…¨ç‹€æ…‹æå‡ï¼");
                }
                
                setPlayer(newPlayer);

                // Remove enemy from map
                const newMap = [...map];
                newMap[playerPos.y][playerPos.x] = ENTITIES.FLOOR;
                setMap(newMap);

                if (currentEnemy.id === 'dragon') {
                    setScreen('win');
                } else {
                    setScreen('map');
                }
            };

            // --- Logic: Shop ---
            const buyItem = (item) => {
                if (item === 'potion' && player.gold >= 20) {
                    setPlayer(p => ({ ...p, gold: p.gold - 20, potions: p.potions + 1 }));
                    addLog("è³¼è²·äº†å›å¾©è—¥æ°´ã€‚");
                } else if (item === 'upgrade' && player.gold >= 50) {
                    setPlayer(p => ({ ...p, gold: p.gold - 50, atk: p.atk + 5 }));
                    addLog("å¼·åŒ–äº†æ­¦å™¨ï¼æ”»æ“ŠåŠ›ä¸Šå‡ã€‚");
                } else {
                    addLog("é‡‘å¹£ä¸è¶³ï¼");
                }
            };

            // --- Utils ---
            const addLog = (msg) => {
                setLogs(prev => [msg, ...prev.slice(0, 4)]);
            };

            const triggerShake = () => {
                setShake(true);
                setTimeout(() => setShake(false), 500);
            };

            const resetGame = () => {
                setPlayer({
                    name: 'å†’éšªè€…',
                    icon: 'ğŸ‘¤',
                    maxHp: 50,
                    hp: 50,
                    atk: 10,
                    lvl: 1,
                    exp: 0,
                    expToNext: 50,
                    gold: 0,
                    potions: 1
                });
                setLogs(['æ­¡è¿ä¾†åˆ°å‹‡è€…è¿·å®®ï¼è«‹é¸æ“‡ä½ çš„è·æ¥­ã€‚']);
                setScreen('start');
            };

            // Keyboard Controls
            useEffect(() => {
                const handleKeyDown = (e) => {
                    if (screen === 'map') {
                        if (e.key === 'ArrowUp' || e.key === 'w') movePlayer(0, -1);
                        if (e.key === 'ArrowDown' || e.key === 's') movePlayer(0, 1);
                        if (e.key === 'ArrowLeft' || e.key === 'a') movePlayer(-1, 0);
                        if (e.key === 'ArrowRight' || e.key === 'd') movePlayer(1, 0);
                    }
                };
                window.addEventListener('keydown', handleKeyDown);
                return () => window.removeEventListener('keydown', handleKeyDown);
            }, [screen, playerPos, map]);


            // --- Render Components ---
            
            // 1. Start Screen
            if (screen === 'start') {
                return (
                    <div className="w-full h-full min-h-screen bg-stone-900 text-white flex flex-col items-center justify-center p-4 font-mono">
                        <h1 className="text-5xl font-bold mb-6 text-yellow-500 animate-bounce">å‹‡è€…è¿·å®®</h1>
                        <div className="bg-stone-800 p-8 rounded-lg border-4 border-stone-600 shadow-2xl text-center max-w-md">
                            <p className="mb-4 text-gray-300">é¸æ“‡ä½ çš„è·æ¥­ï¼Œæ¢ç´¢è¿·å®®ï¼Œæ“Šæ•—æƒ¡é¾ï¼</p>
                            <div className="flex justify-center space-x-4 mb-6 text-4xl">
                                <span>ğŸ›¡ï¸</span><span>ğŸ”®</span><span>ğŸ—¡ï¸</span>
                            </div>
                            <button 
                                onClick={() => setScreen('charSelect')}
                                className="px-8 py-3 bg-blue-600 hover:bg-blue-500 text-white font-bold rounded shadow-[0_4px_0_rgb(30,58,138)] active:shadow-none active:translate-y-1 transition-all"
                            >
                                å»ºç«‹è§’è‰²
                            </button>
                        </div>
                    </div>
                );
            }

            // 2. Character Selection Screen
            if (screen === 'charSelect') {
                return (
                    <div className="w-full h-full min-h-screen bg-stone-900 text-white flex flex-col items-center justify-center p-4 font-mono">
                        <h2 className="text-3xl font-bold mb-8 text-white">é¸æ“‡ä½ çš„è·æ¥­</h2>
                        <div className="grid grid-cols-1 md:grid-cols-3 gap-6 max-w-4xl w-full">
                            {Object.entries(CLASSES).map(([key, cls]) => (
                                <button 
                                    key={key}
                                    onClick={() => selectClass(key)}
                                    className="bg-stone-800 hover:bg-stone-700 border-2 border-stone-600 hover:border-yellow-500 p-6 rounded-lg transition-all transform hover:-translate-y-1 flex flex-col items-center group"
                                >
                                    <div className="text-6xl mb-4 group-hover:scale-110 transition-transform">{cls.icon}</div>
                                    <h3 className="text-xl font-bold mb-2 text-yellow-400">{cls.name}</h3>
                                    <p className="text-gray-400 text-sm mb-4 text-center h-10">{cls.desc}</p>
                                    <div className="text-sm w-full space-y-1">
                                        <div className="flex justify-between text-red-400"><span>HP</span> <span>{cls.hp}</span></div>
                                        <div className="flex justify-between text-blue-400"><span>ATK</span> <span>{cls.atk}</span></div>
                                    </div>
                                </button>
                            ))}
                        </div>
                        <button onClick={() => setScreen('start')} className="mt-8 text-gray-500 hover:text-white underline">è¿”å›</button>
                    </div>
                );
            }

            // 3. Main Game UI Wrapper
            return (
                <div className={`w-full h-full min-h-screen bg-stone-900 text-white font-mono flex flex-col ${shake ? 'animate-shake' : ''}`}>
                    {/* Top Bar: Stats */}
                    <div className="bg-stone-800 p-3 border-b border-stone-700 flex justify-between items-center text-sm sm:text-base sticky top-0 z-10 shadow-md">
                        <div className="flex items-center space-x-4">
                            <div className="flex items-center text-white font-bold"><span className="mr-1">ğŸ‘¤</span> {player.name}</div>
                            <div className="flex items-center text-red-400"><span className="mr-1">â¤ï¸</span> {player.hp}/{player.maxHp}</div>
                        </div>
                        <div className="flex items-center space-x-4">
                            <div className="flex items-center text-yellow-400"><span className="mr-1">ğŸ’°</span> {player.gold}</div>
                            <div className="flex items-center text-blue-400"><span className="mr-1">âœ¨</span> LV:{player.lvl}</div>
                            <div className="flex items-center text-green-400"><span className="mr-1">ğŸ›ï¸</span> x{player.potions}</div>
                        </div>
                    </div>

                    {/* Main Content Area */}
                    <div className="flex-1 flex flex-col items-center justify-center p-4 overflow-hidden relative">
                        
                        {/* MAP VIEW */}
                        {screen === 'map' && (
                            <div className="relative">
                                <div 
                                    className="grid gap-1 bg-stone-950 p-2 rounded border border-stone-700 shadow-2xl"
                                    style={{ gridTemplateColumns: `repeat(${MAP_SIZE}, 1fr)` }}
                                >
                                    {map.map((row, y) => row.map((tile, x) => {
                                        const isPlayer = playerPos.x === x && playerPos.y === y;
                                        const isRevealed = revealedTiles.some(t => t.x === x && t.y === y);
                                        
                                        return (
                                            <div 
                                                key={`${x}-${y}`}
                                                className={`
                                                    w-8 h-8 sm:w-10 sm:h-10 flex items-center justify-center text-lg sm:text-2xl rounded-sm
                                                    ${isPlayer ? 'bg-blue-900 z-10' : ''}
                                                    ${!isRevealed ? 'bg-black' : tile === ENTITIES.WALL ? tile.color : 'bg-stone-800'}
                                                    transition-colors duration-300
                                                `}
                                            >
                                                {isPlayer ? player.icon : (isRevealed ? tile.icon : '')}
                                            </div>
                                        );
                                    }))}
                                </div>
                                
                                {/* Mobile Controls */}
                                <div className="mt-8 grid grid-cols-3 gap-2 max-w-[200px] mx-auto md:hidden">
                                    <div />
                                    <button className="bg-stone-700 p-4 rounded active:bg-stone-600 text-xl" onClick={() => movePlayer(0, -1)}>â¬†ï¸</button>
                                    <div />
                                    <button className="bg-stone-700 p-4 rounded active:bg-stone-600 text-xl" onClick={() => movePlayer(-1, 0)}>â¬…ï¸</button>
                                    <button className="bg-stone-700 p-4 rounded active:bg-stone-600 text-xl" onClick={() => movePlayer(0, 1)}>â¬‡ï¸</button>
                                    <button className="bg-stone-700 p-4 rounded active:bg-stone-600 text-xl" onClick={() => movePlayer(1, 0)}>â¡ï¸</button>
                                </div>
                            </div>
                        )}

                        {/* SHOP VIEW */}
                        {screen === 'shop' && (
                            <div className="bg-stone-800 p-6 rounded-lg border-2 border-green-600 max-w-md w-full shadow-2xl animate-in fade-in zoom-in">
                                <h2 className="text-2xl mb-4 text-green-400 flex items-center justify-center"><span className="mr-2">ğŸ›ï¸</span> ç¥ç§˜å•†åº—</h2>
                                <p className="text-center text-gray-400 mb-6">ã€Œæƒ³è¦åœ¨é€™å€‹å±éšªçš„åœ°æ–¹æ´»ä¸‹å»å—ï¼Ÿã€</p>
                                
                                <div className="space-y-4">
                                    <button 
                                        onClick={() => buyItem('potion')}
                                        className="w-full flex justify-between items-center p-4 bg-stone-700 hover:bg-stone-600 rounded border border-stone-600"
                                    >
                                        <span className="flex items-center"><span className="mr-2">â¤ï¸</span> å›å¾©è—¥æ°´ (HP+30)</span>
                                        <span className="text-yellow-400">20 G</span>
                                    </button>
                                    
                                    <button 
                                        onClick={() => buyItem('upgrade')}
                                        className="w-full flex justify-between items-center p-4 bg-stone-700 hover:bg-stone-600 rounded border border-stone-600"
                                    >
                                        <span className="flex items-center"><span className="mr-2">âš”ï¸</span> æ­¦å™¨å¼·åŒ– (ATK+5)</span>
                                        <span className="text-yellow-400">50 G</span>
                                    </button>
                                </div>

                                <button 
                                    onClick={() => setScreen('map')}
                                    className="mt-6 w-full py-3 bg-gray-600 hover:bg-gray-500 rounded font-bold"
                                >
                                    é›¢é–‹å•†åº—
                                </button>
                            </div>
                        )}

                        {/* BATTLE VIEW */}
                        {screen === 'battle' && currentEnemy && (
                            <div className="bg-stone-800 p-6 rounded-lg border-2 border-red-600 max-w-md w-full shadow-[0_0_30px_rgba(220,38,38,0.3)] animate-in fade-in zoom-in">
                                <div className="flex justify-between items-start mb-8">
                                    <div className="text-center w-1/2">
                                        <div className="text-6xl mb-2 animate-bounce">{currentEnemy.icon}</div>
                                        <div className="text-xl font-bold text-red-400">{currentEnemy.name}</div>
                                        <div className="w-full bg-stone-900 h-2 rounded-full mt-2 overflow-hidden">
                                            <div 
                                                className="bg-red-600 h-full transition-all duration-300"
                                                style={{ width: `${(currentEnemy.hp / currentEnemy.maxHp) * 100}%` }}
                                            ></div>
                                        </div>
                                        <div className="text-xs mt-1 text-gray-400">HP: {currentEnemy.hp}</div>
                                    </div>
                                    
                                    <div className="flex flex-col items-center justify-center w-1/6 pt-6">
                                        <span className="text-2xl font-bold text-gray-500">VS</span>
                                    </div>

                                    <div className="text-center w-1/2">
                                        <div className="text-6xl mb-2">{player.icon}</div>
                                        <div className="text-xl font-bold text-blue-400">{player.name}</div>
                                        <div className="w-full bg-stone-900 h-2 rounded-full mt-2 overflow-hidden">
                                            <div 
                                                className="bg-blue-500 h-full transition-all duration-300"
                                                style={{ width: `${(player.hp / player.maxHp) * 100}%` }}
                                            ></div>
                                        </div>
                                        <div className="text-xs mt-1 text-gray-400">HP: {player.hp}</div>
                                    </div>
                                </div>

                                {/* Battle Logs */}
                                <div className="h-24 overflow-y-auto bg-black/30 p-2 rounded mb-4 text-sm space-y-1 font-sans">
                                    {battleLog.map((log, i) => (
                                        <div key={i} className="text-gray-300 border-l-2 border-gray-600 pl-2">{log}</div>
                                    ))}
                                </div>

                                {/* Actions */}
                                <div className="grid grid-cols-2 gap-3">
                                    <button 
                                        onClick={() => battleAction('attack')} disabled={!isPlayerTurn}
                                        className="flex flex-col items-center justify-center p-3 bg-red-900 hover:bg-red-800 disabled:opacity-50 rounded border-b-4 border-red-950 active:border-b-0 active:translate-y-1 transition-all"
                                    >
                                        <span className="mb-1 text-xl">âš”ï¸</span> æ”»æ“Š
                                    </button>
                                    <button 
                                        onClick={() => battleAction('heal')} disabled={!isPlayerTurn}
                                        className="flex flex-col items-center justify-center p-3 bg-green-900 hover:bg-green-800 disabled:opacity-50 rounded border-b-4 border-green-950 active:border-b-0 active:translate-y-1 transition-all"
                                    >
                                        <span className="mb-1 text-xl">â¤ï¸</span> æ²»ç™‚ (x{player.potions})
                                    </button>
                                    <button 
                                        onClick={() => battleAction('run')} disabled={!isPlayerTurn}
                                        className="col-span-2 p-2 bg-stone-700 hover:bg-stone-600 disabled:opacity-50 rounded text-sm"
                                    >
                                        <span className="inline-block mr-1">ğŸ‘£</span> å˜—è©¦é€ƒè·‘
                                    </button>
                                </div>
                            </div>
                        )}

                        {/* WIN SCREEN */}
                        {screen === 'win' && (
                            <div className="bg-stone-800 p-8 rounded-lg border-4 border-yellow-500 text-center max-w-md shadow-2xl animate-in zoom-in">
                                <div className="text-6xl mb-4">ğŸ†</div>
                                <h2 className="text-3xl font-bold text-yellow-400 mb-2">å‚³èªªé”æˆï¼</h2>
                                <p className="text-gray-300 mb-6">ä½ æ“Šæ•—äº†æ·±æ·µé­”é¾ï¼Œå’Œå¹³é‡æ­¸å¤§åœ°ã€‚</p>
                                <div className="text-sm text-gray-400 mb-6 bg-stone-900 p-4 rounded">
                                    è·æ¥­: {player.name} <br/>
                                    æœ€çµ‚ç­‰ç´š: {player.lvl} <br/>
                                    å‰©é¤˜é‡‘å¹£: {player.gold}
                                </div>
                                <button onClick={resetGame} className="px-6 py-2 bg-yellow-600 hover:bg-yellow-500 rounded font-bold">
                                    å†æ¬¡å†’éšª
                                </button>
                            </div>
                        )}

                        {/* GAME OVER SCREEN */}
                        {screen === 'gameover' && (
                            <div className="bg-stone-800 p-8 rounded-lg border-4 border-red-900 text-center max-w-md shadow-2xl animate-in zoom-in">
                                <div className="text-6xl mb-4">ğŸ’€</div>
                                <h2 className="text-3xl font-bold text-red-500 mb-2">å‹æ•—ä¹ƒå…µå®¶å¸¸äº‹</h2>
                                <p className="text-gray-300 mb-6">{player.name} å€’ä¸‹äº†ï¼Œä½†å‚³èªªä¸æœƒçµæŸ...</p>
                                <button onClick={resetGame} className="px-6 py-2 bg-stone-600 hover:bg-stone-500 rounded font-bold flex items-center mx-auto">
                                    <span className="mr-2">ğŸ”„</span> é‡æ–°é–‹å§‹
                                </button>
                            </div>
                        )}

                    </div>

                    {/* Bottom Log Bar (Global) */}
                    <div className="bg-black p-2 border-t border-stone-800 h-24 overflow-y-auto text-sm font-sans">
                        <div className="text-xs text-gray-500 mb-1">=== å†’éšªæ—¥èªŒ ===</div>
                        {logs.map((log, i) => (
                            <div key={i} className="text-gray-300 mb-0.5">&gt; {log}</div>
                        ))}
                    </div>
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<RPGGame />);
    </script>
</body>
</html>